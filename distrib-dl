#!/bin/bash
# Download and verify Linux distribution installers/ISO images
# https://github.com/nodiscc/distrib-dl

set -o errexit
set -o nounset
set -o pipefail

##############################
# Configuration

### DEBIAN
# one of: amd64 armel armhf i386 ia64 kfreebsd-amd64 kfreebsd-i386 mips mipsel multi-arch powerpc s390 s390x source sparc
debian_architecture="amd64"
debian_version="13.3.0"
# one of: amd64, i386
debian_live_architecture="amd64"
# one of: cinnamon gnome kde lxde lxqt mate xfce
debian_live_desktop_environment="xfce"
### TAILS
tails_architecture="amd64"
tails_version="7.1"
### KALI
kali_architecture="amd64"
kali_version="2025.4"
kali_flavour="installer"
### PROXMOX
# https://www.proxmox.com/en/downloads/proxmox-virtual-environment/iso
proxmox_version="8.4-1"
### PFSENSE
pfsense_version="2.7.2"
pfsense_installer_type="vga" #serial or vga
### FREEBSD
freebsd_version="13.2"
### DEBIAN-LIVE-CONFIG
# https://gitlab.com/nodiscc/debian-live-config
# https://github.com/nodiscc/debian-live-config/releases/
debian_live_config_version="4.2.0"
### FEDORA WORKSTATION
fedora_version_major="41"
fedora_version_minor="1.4"
### UBUNTU DESKTOP
ubuntu_architecture="amd64"
ubuntu_version="22.04.5"
### ARCHLINUX
archlinux_version="2026.01.01"

############################

# abort on errors
set -o errexit

download_dir="$PWD"
usage="$0 [OPTIONS] DISTRIBUTION1 [DISTRIBUTION2 DISTRIBUTION3 ...] [all]
Available distributions: debian debian-live tails kali proxmox pfsense freebsd debian-live-config fedora ubuntu arch
Options:
-c        only check that the url returns 200, don't download anything
-d DIR    specify base download directory (by default the current working directory is used)
-h        show help"

############################

download_and_verify() {
    local dir=$1          # e.g. "$download_dir/debian"
    local base_url=$2     # base URL for the files
    local iso=$3          # ISO filename
    local sums=$4         # checksums file
    local sig=$5          # signature file (may be empty)
    local key=$6          # key file (may be empty)
    local verify=$7       # "true"/"false"

    mkdir -p "$dir"

    echo "[distrib-dl] Downloading $sums and $sig ..."
    wget $wget_opts --timestamping --show-progress --directory-prefix="$dir/" "$base_url/$sums"
    [[ -n $sig ]] && wget $wget_opts --timestamping --show-progress --directory-prefix="$dir/" "$base_url/$sig"
    [[ -n $key ]] && wget $wget_opts --timestamping --show-progress --directory-prefix="$dir/" "$key"

    if [[ $verify == "true" && -n $sig ]]; then
        echo "[distrib-dl] Verifying signature..."
        gpg --import "$dir/$(basename "$key")" 2>/dev/null || true
        gpg --verify "$dir/$(basename "$sig")" "$dir/$(basename "$sums")"
    fi

    echo "[distrib-dl] Downloading ISO image..."
    wget $wget_opts --timestamping --show-progress --directory-prefix="$dir/" "$base_url/$iso"

    if [[ $verify == "true" ]]; then
        echo "[distrib-dl] Verifying ISO integrity..."
        (cd "$dir" && sha${#sums%.*}sum --check --ignore-missing <(cat "$sums"))
    fi
}

##############

function download_debian() {
    local dir="$download_dir/debian"
    download_and_verify \
        "$dir" \
        "https://cdimage.debian.org/debian-cd/current/${debian_architecture}/iso-cd/" \
        "debian-${debian_version}-${debian_architecture}-netinst.iso" \
        "SHA512SUMS" \
        "SHA512SUMS.sign" \
        "" \
        "$verify"
}

function download_debian_live() {
    local dir="$download_dir/debian-live"
    download_and_verify \
        "$dir" \
        "https://cdimage.debian.org/cdimage/release/current-live/${debian_live_architecture}/iso-hybrid/" \
        "debian-live-${debian_version}-${debian_live_architecture}-${debian_live_desktop_environment}.iso" \
        "SHA512SUMS" \
        "SHA512SUMS.sign" \
        "" \
        "$verify"
}

function download_tails() {
    if [[ ! -d "$download_dir/tails/" ]]; then mkdir -p "$download_dir/tails/"; fi
    tails_iso_url="https://mirrors.wikimedia.org/tails/stable/tails-${tails_architecture}-${tails_version}/tails-${tails_architecture}-${tails_version}.iso"
    tails_key_url="https://tails.boum.org/tails-signing.key"
    tails_sig_url="https://tails.boum.org/torrents/files/tails-${tails_architecture}-${tails_version}.iso.sig"
    echo "[distrib-dl] INFO: downloading Tails key and signature..."
    # shellcheck disable=SC2086
    wget $wget_opts --continue --timestamping --show-progress --directory-prefix="$download_dir/tails/" "$tails_key_url"
    # shellcheck disable=SC2086
    wget $wget_opts --continue --timestamping --show-progress --directory-prefix="$download_dir/tails/" "$tails_sig_url"
    if [[ "$verify" == "true" ]]; then
        echo "[distrib-dl] INFO: Importing tails GPG key..."
        gpg --import "$download_dir/tails/tails-signing.key"
    fi
    echo "[distrib-dl] INFO: downloading Tails ISO image"
    # shellcheck disable=SC2086
    wget $wget_opts --continue --timestamping --show-progress --directory-prefix="$download_dir/tails/" "$tails_iso_url"
    if [[ "$verify" == "true" ]]; then
        echo "[distrib-dl] INFO: verifying Tails signature..."
        tails_sig_filename="tails-${tails_architecture}-${tails_version}.iso.sig"
        tails_iso_filename="tails-${tails_architecture}-${tails_version}.iso"
        gpg --keyid-format 0xlong --verify "$download_dir/tails/$tails_sig_filename" "$download_dir/tails/$tails_iso_filename"
    fi
}

function download_kali() {
    local dir="$download_dir/kali"
    download_and_verify \
        "$dir" \
        "https://cdimage.kali.org/kali-${kali_version}/" \
        "kali-linux-${kali_version}-${kali_flavour}-${kali_architecture}.iso" \
        "SHA256SUMS" \
        "SHA256SUMS.gpg" \
        "https://archive.kali.org/archive-key.asc" \
        "$verify"
}

function download_proxmox {
    # https://pve.proxmox.com/wiki/Roadmap
    # TODO checksums/gpg verify download
    local dir="$download_dir/proxmox"
    download_and_verify \
        "$dir" \
        "https://enterprise.proxmox.com/iso" \
        "proxmox-ve_${proxmox_version}.iso" \
        "" \
        "" \
        "" \
        "false"
}

function download_pfsense {
    # New York mirror (disabled)
    #pfsense_base_url="https://nyifiles.pfsense.org/mirror/downloads"
    # Main site (disabled, does not redirect properly)
    #pfsense_base_url="https://files.pfsense.org/mirror/downloads"
    # Frankfurt mirror
    pfsense_base_url="https://frafiles.pfsense.org/mirror/downloads"
    if [[ "$pfsense_installer_type" == "serial" ]]; then pfsense_is_serial="serial-"
        elif [[ "$pfsense_installer_type" == "vga" ]]; then pfsense_is_serial=""
        else echo "[distrib-dl] ERROR: invalid installer type for pfsense: $pfsense_installer_type"; exit 1
    fi
    pfsense_iso_filename="pfSense-CE-memstick-${pfsense_is_serial}${pfsense_version}-RELEASE-amd64.img.gz"
    pfsense_hashes_base_url="https://www.pfsense.org/hashes/"
    if [[ ! -d "$download_dir/pfsense/" ]]; then mkdir -p "$download_dir/pfsense/"; fi
    echo "[distrib-dl] INFO: downloading pfsense checksums..."
    # shellcheck disable=SC2086
    wget $wget_opts --continue --timestamping --show-progress --directory-prefix="$download_dir/pfsense/" "${pfsense_hashes_base_url}/${pfsense_iso_filename}.sha256"
    echo "[distrib-dl] INFO: downloading pfsense ISO image..."
    # shellcheck disable=SC2086
    wget $wget_opts --continue --timestamping --show-progress --directory-prefix="$download_dir/pfsense/" "${pfsense_base_url}/${pfsense_iso_filename}"
    if [[ "$verify" == "true" ]]; then
        echo "[distrib-dl] INFO: verifying pfsense ISO image integrity..."
        (cd "$download_dir/pfsense" && sha256sum --check "pfSense-CE-memstick-${pfsense_is_serial}${pfsense_version}-RELEASE-amd64.img.gz.sha256")
    fi
}

function download_freebsd() {
    freebsd_base_url="https://download.freebsd.org/ftp/releases/amd64/amd64/ISO-IMAGES/${freebsd_version}"
    freebsd_iso_filename="FreeBSD-${freebsd_version}-RELEASE-amd64-memstick.img"
    freebsd_sums_filename="CHECKSUM.SHA512-FreeBSD-${freebsd_version}-RELEASE-amd64"
    freebsd_gpgkeyring_url="https://docs.freebsd.org/pgpkeys/pgpkeys.txt"
    if [[ ! -d "$download_dir/freebsd/" ]]; then mkdir -p "$download_dir/freebsd/"; fi
    echo "[distrib-dl] INFO: Downloading freebsd keyring, checksums and signature..."
    # shellcheck disable=SC2086
    wget $wget_opts --timestamping --show-progress --directory-prefix="$download_dir/freebsd/" "$freebsd_gpgkeyring_url"
    # shellcheck disable=SC2086
    wget $wget_opts --timestamping --show-progress --directory-prefix="$download_dir/freebsd/" "$freebsd_base_url/$freebsd_sums_filename"
    echo "[distrib-dl] INFO: Downloading freebsd ISO image..."
    # shellcheck disable=SC2086
    wget $wget_opts --continue --timestamping --show-progress --directory-prefix="$download_dir/freebsd/" "$freebsd_base_url/$freebsd_iso_filename"
    if [[ "$verify" == "true" ]]; then
        echo "Verifying freebsd ISO image integrity..."
        (cd "$download_dir/freebsd/" && sha512sum --ignore-missing -c <(cat ${freebsd_sums_filename}))
    fi
}

function download_debian_live_config() {
    local dir="$download_dir/debian-live-config"
    local base_url="https://github.com/nodiscc/debian-live-config/releases/download/$debian_live_config_version/"
    local iso="debian-live-config-${debian_live_config_version}-debian-bookworm-amd64.iso"
    local sums="SHA512SUMS"
    local sig="SHA512SUMS.sign"
    local key="${base_url}debian-live-config-release.key"
    download_and_verify "$dir" "$base_url" "$iso" "$sums" "$sig" "$key" "$verify"
}


function download_fedora() {
    local dir="$download_dir/fedora"
    local base_url="https://download.fedoraproject.org/pub/fedora/linux/releases/${fedora_version_major}/Workstation/x86_64/iso"
    local iso="Fedora-Workstation-Live-x86_64-${fedora_version_major}-${fedora_version_minor}.iso"
    local sums="Fedora-Workstation-${fedora_version_major}-${fedora_version_minor}-x86_64-CHECKSUM"
    local key="https://fedoraproject.org/fedora.gpg"
    download_and_verify "$dir" "$base_url" "$iso" "$sums" "" "$key" "$verify"
}

function download_ubuntu() {
    local dir="$download_dir/ubuntu"
    local base_url="https://releases.ubuntu.com/${ubuntu_version}"
    local iso="ubuntu-${ubuntu_version}-desktop-${ubuntu_architecture}.iso"
    local sums="SHA256SUMS"
    local sig="SHA256SUMS.gpg"
    local key=""
    download_and_verify "$dir" "$base_url" "$iso" "$sums" "$sig" "$key" "$verify"
    # Verify signature using keyserver (since no key file provided)
    if [[ "$verify" == "true" ]]; then
        echo "[distrib-dl] Verifying Ubuntu signature..."
        gpg --keyid-format long --keyserver hkp://keyserver.ubuntu.com --recv-keys 0x843938DF228D22F7B3742BC0D94AA3F0EFE21092
        gpg --keyid-format long --verify "$download_dir/ubuntu/SHA256SUMS.gpg" "$download_dir/ubuntu/SHA256SUMS"
    fi
}

function download_archlinux() {
    archlinux_base_url="https://geo.mirror.pkgbuild.com/iso/${archlinux_version}/"
    archlinux_iso_filename="archlinux-x86_64.iso"
    archlinux_sums_url="https://archlinux.org/iso/${archlinux_version}/sha256sums.txt"
    archlinux_sums_sign_url="https://geo.mirror.pkgbuild.com/iso/${archlinux_version}/archlinux-x86_64.iso.sig"
    if [[ ! -d "$download_dir/archlinux/" ]]; then mkdir -p "$download_dir/archlinux/"; fi
    echo "[distrib-dl] Downloading Arch Linux checksums and signature..."
    # shellcheck disable=SC2086
    wget $wget_opts --timestamping --show-progress --directory-prefix="$download_dir/archlinux/" "$archlinux_sums_url"
    # shellcheck disable=SC2086
    wget $wget_opts --timestamping --show-progress --directory-prefix="$download_dir/archlinux/" "$archlinux_sums_sign_url"
    echo "[distrib-dl] Downloading Arch Linux ISO image..."
    # shellcheck disable=SC2086
    wget $wget_opts --timestamping --show-progress --directory-prefix="$download_dir/archlinux/" "$archlinux_base_url/$archlinux_iso_filename"
    if [[ "$verify" == "true" ]]; then
        echo "[distrib-dl] Verifying Arch Linux signature..."
        gpg --auto-key-locate clear,wkd -v --locate-external-key pierre@archlinux.org
        gpg --verify "$download_dir/archlinux/archlinux-x86_64.iso.sig" "$download_dir/archlinux/archlinux-x86_64.iso"
        echo "[distrib-dl] Verifying Arch Linux ISO image integrity..."
        (cd "$download_dir/archlinux/" && sha256sum --check --ignore-missing <(cat sha256sums.txt))
    fi
}

function _main() {
    wget_opts="--no-verbose"
    verify="true"
    while getopts ":cd:h" opt; do
        case $opt in
            c) wget_opts="--spider"; verify="false"; shift;;
            d) download_dir="$OPTARG"; shift;;
            h) echo "Usage: $usage"; exit 0;;
            \?) echo "[distrib-dl] ERROR: invalid option -$OPTARG" >&2; echo "Usage: $usage"; exit 1;;
        esac
    done

    for distribution in "$@"; do
        if [[ "$distribution" == "debian" ]] ; then download_debian; fi
        if [[ "$distribution" == "debian-live" ]] ; then download_debian_live; fi
        if [[ "$distribution" == "tails" ]] ; then download_tails; fi
        if [[ "$distribution" == "kali" ]] ; then download_kali; fi
        if [[ "$distribution" == "proxmox" ]] ; then download_proxmox; fi
        if [[ "$distribution" == "pfsense" ]] ; then download_pfsense; fi
        if [[ "$distribution" == "freebsd" ]] ; then download_freebsd; fi
        if [[ "$distribution" == "debian-live-config" ]] ; then download_debian_live_config; fi
        if [[ "$distribution" == "fedora" ]] ; then download_fedora; fi
        if [[ "$distribution" == "ubuntu" ]] ; then download_ubuntu; fi
        if [[ "$distribution" == "archlinux" ]] ; then download_archlinux; fi
        if [[ "$distribution" == "all" ]] ; then download_debian && download_debian_live && download_tails && download_kali && download_proxmox && download_pfsense && download_freebsd && download_debian_live_config && download_fedora && download_ubuntu && download_archlinux; fi
    done
}

#####################

_main "$@"
